<!DOCTYPE html>
<html>
<head id="Head1">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>成都贝臣齿科客户管理系统</title>
    <!-- <link href="__PUBLIC__static/css/default.css" rel="stylesheet" type="text/css" /> -->
    <link href="__PUBLIC__static/easyui/css/easyui.css" rel="stylesheet" type="text/css" />
    <link href="__PUBLIC__static/easyui/css/icon.css" rel="stylesheet" type="text/css" />
    <link href="http://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

    <script src="__PUBLIC__static/easyui/js/jquery.min.js" type="text/javascript"></script>
    <script src="__PUBLIC__static/easyui/js/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="__PUBLIC__static/easyui/js/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <style>
        td{text-align: center;}
        #eastform{visibility: hidden;}
    </style>
</head>

<body class="easyui-layout" style="overflow-y: hidden" scroll="no">
    <div class="easyui-layout" style="width:100%;height:100%;">
        <!-- <div data-options="region:'north'" style="height:50px"></div> -->
        <!-- <div data-options="region:'south',split:true" style="height:50px;"></div> -->
        <div data-options="region:'west',split:true" title="字典类别" style="width:200px;">
            <ul class="easyui-tree">
                <li id="dev_from" data-options="checked:true">
                    <span>开发渠道</span>
                    <ul>
                        <li id="source">
                            <span>信息来源</span>
                        </li>

                        <li id="zx_tools">
                            <span>咨询工具</span>
                        </li>
                    </ul>
                </li>
                <li id="disease">
                    <span>病种类型</span>
                </li>
                <li id="doctors">
                    <span>接诊医生</span>
                </li>
                <li id="wangdian_zixun">
                    <span>网电咨询师</span>
                </li>
                <li id="qiantai_zixun">
                    <span>前台咨询师</span>
                </li>
        </div>
        <div data-options="region:'center',title:'字典项列表'">
            <!-- 工具栏 -->
            <!-- <div id="tb" style="padding:5px;height:auto">
                <div style="margin-bottom:5px">
                    <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true"></a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true"></a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-save" plain="true"></a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-cut" plain="true"></a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true"></a>
                </div>
            </div> -->
            <table id="staffGird">
            </table>

        </div>
        <div id="east" data-options="region:'east',split:true" title="详细信息" style="width:500px;">
            <form action="" id="eastform">
                <table cellpadding="10">
                    <tr style="display: block;">
                        <td class="nametext" style="width:90px;text-align:right;"></td>
                        <td><input class="easyui-textbox" type="text" name="name" data-options="required:true" id="name" value=""></input></td>
                    </tr>
                    <tr class="fatherDom">
                        <td style="width:90px;text-align:right;">开发渠道</td>
                        <td>
                            <select class="easyui-combobox" id="dev_from" name="dev_from" data-options="panelHeight:'auto',editable:false">
                                {volist name='dev' id='vo'}
                                <option value="{$vo.id}">{$vo.dev}</option>
                                {/volist}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div style="text-align:center;padding:5px">
                                <a id="save" href="javascript:void(0)" class="easyui-linkbutton">保存</a>
                                <a id="reset" href="javascript:void(0)" class="easyui-linkbutton">清除</a>
                            </div>
                        </td>
                    </tr>
                </table>
            </form>
        </div>


    </div>

    <script>
        // 点击字典类别加载对应字典项列表
        var selectedId=null;
        $('.easyui-tree').tree({
            animate:true,
            lines:true,
            onClick: function(node) {
                $('#eastform').css('visibility','visible');
                $('#eastform').form('load',{
                    name:''
                });
                // $('#eastform').show();
                selectedId = node.id;//获取当前选中节点的id
                // console.log(selectedId);
                var father = $(this).tree("getParent",node.target);//获取当前节点的父节点
                // console.log(father)
                var child = $(this).tree("getChildren",node.target);//获取当前节点的子节点 返回数组
                // console.log(child.length);//子节点个数
                $.ajax({
                    url: "{:url('getTreeList')}?r="+Math.random(),
                    type: 'POST',
                    dataType: 'json',
                    data: {table: selectedId}
                })
                .done(function(data) {
                    if(data.bodys=='没有数据'){
                        $('#staffGird').datagrid({
                            title:"没有相关信息",
                            data:[],
                            columns:[]
                        });
                        $('#eastform').hide();
                        return false;
                    }
                    $('.nametext').html(node.text+"名称");
                    if(!(child.length==0 && father)){
                        $('.fatherDom').css('display','none');
                    }else{
                        $('.fatherDom').css('display','block');
                    }

                    var columns=[];
                    $.each(data.headers[0], function(i, field){
                        var column={};
                        column["title"]=i;
                        column["field"]=field;
                        column["width"]=100;
                        columns.push(column);//当需要formatter的时候自己添加就可以了,原理就是拼接字符串.
                    });
                    // console.log(columns)
                    $('#staffGird').datagrid({
                        // height:500,
                        title:'',
                        singleSelect:true,
                        url:'',
                        /*frozenColumns :[[
                            {field:'name',title:'项目',width:80,sortable:true,align:'center'},
                            {field:'count',title:'合计',width:150,sortable:true}
                        ]],*/
                        columns : [
                            columns
                        ],
                        rownumbers:true,

                    }).datagrid('loadData',data.bodys);
                })
                .fail(function() {
                    console.log("error");
                });
            }
        });

        // 填充详细信息表单
        var aFields=[];
        $('#staffGird').datagrid({
            onClickRow:function(index, row){
                aFields=$('#staffGird').datagrid('getColumnFields');
                // return
                var table=$('#staffGird').datagrid('getSelected');
                if(row && selectedId){
                    // console.log(selectedId);
                    var tableName=selectedId,
                        id=row.id;
                    // 加载数据
                    var arr=[];
                    for(var i in row){
                        arr.push(row[i]);
                    }
                    // console.log(arr)
                    $('#eastform').form('load',{
                        name:arr[1]
                    });

                    if($('.fatherDom').css("display")  =='block'){

                        $('#dev_from').combobox('select',row.pid);
                    }


                }else{
                    $('#eastform').form('load',{
                        name:''
                    });
                }
                // console.log(index)
            }
        });

        // 保存数据
        $('#save').on('click',function(){
            if(!$('#name').val()){
                return false;
            }
            var fieldname=aFields[1];
            console.log($('#staffGird').datagrid('getColumnFields'));

            $.ajax({
                url: '{:url("edit")}?r='+Math.random(),
                type: 'POST',
                dataType: 'json',
                // data: {tablename: selectedId,fieldname:$('#name').val()}
                data: 'tablename='+selectedId+'&'+fieldname+'='+$('#name').val()
            })
            .done(function(data) {
                // console.log(data);
            })
            .fail(function() {
                console.log("error");
            });
            return false;

        })

    </script>

</body>

</html>
