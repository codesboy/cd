<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>客户数据</title>
<link href="__PUBLIC__static/easyui/css/easyui.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__static/easyui/css/icon.css" rel="stylesheet" type="text/css" />
<script src="__PUBLIC__static/easyui/js/jquery.min.js" type="text/javascript"></script>
<script src="__PUBLIC__static/easyui/js/jquery.easyui.min.js" type="text/javascript"></script>
<script src="__PUBLIC__static/easyui/js/easyui-lang-zh_CN.js" type="text/javascript"></script>
<script type="text/javascript" src="http://www.w3cschool.cc/try/jeasyui/datagrid-detailview.js"></script>

<link rel="stylesheet" href="__PUBLIC__static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="__PUBLIC__static/bootstrap/css/bootstrap-datepicker.min.css">
<script src="__PUBLIC__static/bootstrap/js/bootstrap.min.js"></script>
<script src="__PUBLIC__static/bootstrap/js/bootstrap-datepicker.min.js"></script>
<script src="__PUBLIC__static/bootstrap/js/bootstrap-datepicker.zh-CN.min.js"></script>
<style>
    body{margin: 0;padding: 0;}
    .yes{color: green;}
    .no{color: red;}
    .status{width: 16px;height: 15px;display: inline-block;font-size: 0px;}
    .money{font-weight: bold;color: #f00;}
    td{text-align: center;}
    /* .datagrid-header{position: fixed;} */
    .form-group{padding-bottom: 15px;}
        .control-label{text-align: right;/* width: 20%; */margin-right: 2%;}
        .form-control{width: 60%!important;}
        .line{border-bottom: 1px dashed #ccc;text-align: center;color: #888;margin-bottom: 20px;}
        .btns{text-align: center;}
        #msg{color: #f00;}
</style>

</head>
<body>
        <!-- Button trigger modal -->
<!-- <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
  Launch demo modal
</button> -->

    <table id="dg" class="" title="客户消费情况表">
    </table>
    <div id="toolbar">
        <div style="margin-bottom:5px">
            <a href="#" class="easyui-menubutton" menu="#mm1" iconCls="icon-add">添加</a>
            <div id="mm1" style="width:150px;">
                <div iconCls="icon-undo" data-toggle="modal" data-target="#myModal">新增客户</div>
                <!-- <div iconCls="icon-undo" onclick="$('#myModal').dialog('open')">新增客户</div> -->
                <!-- <div iconCls="icon-undo" onclick="addTab('新增客户','/index/useradd/');">新增客户</div> -->
                <div class="menu-sep"></div>
                <div iconCls="icon-redo">新增消费</div>
            </div>
            <a href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true" title="编辑客户">编辑客户</a>
            <a id="reload" class="easyui-linkbutton" iconCls="icon-reload" plain="true" target="_blank" title="刷新数据">刷新数据</a>
            <a href="{:url('')}" class="easyui-linkbutton" iconCls="icon-more" plain="true" target="_blank" title="全屏显示表格">全屏显示</a>
        </div>
        <div>
            姓名/手机号:<input class="easyui-textbox" type="text" style="width: 100px">
            Date From:<input class="easyui-datebox" style="width:100px">
            To: <input class="easyui-datebox" style="width:100px">
            Language:
            <select class="easyui-combobox" panelHeight="auto" style="width:100px">
                <option value="java">Java</option>
                <option value="c">C</option>
                <option value="basic">Basic</option>
                <option value="perl">Perl</option>
                <option value="python">Python</option>
            </select>
            <a href="#" class="easyui-linkbutton" iconCls="icon-search">Search</a>
        </div>
    </div>
    <!-- 调用分层控制器 -->

<!-- <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
    Launch demo modal
</button> -->
<!-- 添加用户表单 -->
{include file="Public/userAddForm"}
<script>
// $('#myModal').dialog({
//     closed: true,
// })
// 
// datagrid部分js
$(function() {
    var money = 0;
    $('#dg').datagrid({
        iconCls: 'icon-list',
        autoRowHeight: false,
        // nowrap: false,
        url: '{:url('returndata')}',
        columns: [
            [
                // {field:'id',title:'ID',width:1,width:'auto'},
                {
                    field: 'checkbox',
                    checkbox: true
                }, {
                    field: 'name',
                    title: '姓名',
                    width: 80,
                    halign: 'center',
                    align: 'center'
                },
                // {field:'usersn',title:'客户编号',width:100},
                {
                    field: 'status',
                    title: '成交',
                    formatter: statusformater,
                    align: 'center',
                    width: 45
                }, {
                    field: 'sex',
                    title: '性别',
                    formatter: function(value) {
                        if (value == 1) {
                            return '男'
                        } else if (value == 2) {
                            return '女'
                        } else {
                            return '未知'
                        }
                    },
                    width: 45
                }, {
                    field: 'birthday',
                    title: '出生日期',
                    width: 100
                }, {
                    field: 'age',
                    title: '年龄',
                    sortable: true,
                    width: 40
                }, {
                    field: 'telephone',
                    title: '手机号码',
                    width: 100
                }, {
                    field: 'province_name',
                    title: '所在省份',
                    width: 100
                }, {
                    field: 'city_name',
                    title: '所在市区',
                    width: 100
                }, {
                    field: 'county_name',
                    title: '所在区县',
                    width: 100
                }, {
                    field: 'dev',
                    title: '开发渠道',
                    width: 100
                }, {
                    field: 'from',
                    title: '信息来源',
                    width: 100
                }, {
                    field: 'tool',
                    title: '咨询工具',
                    width: 100
                }, {
                    field: 'wdname',
                    title: '最近一次网电咨询师',
                    width: 100
                }, {
                    field: 'qtname',
                    title: '最近一次前台咨询师',
                    width: 100
                }, {
                    field: 'doctor',
                    title: '最近一次接诊医生',
                    width: 100
                }, {
                    field: 'disease_name',
                    title: '最近一次就诊病种',
                    width: 100
                }, {
                    field: 'summoney',
                    title: '消费总金额(元)',
                    sortable: true,
                    formatter: function(value) {
                        return '<span class="money">' + value + '</span>';
                    },
                    width: 100
                }, {
                    field: 'addtime',
                    title: '登记时间',
                    width: 100
                }
            ]
        ],
        toolbar: "#toolbar",
        fitColumns: true, //表格宽度自适应
        rownumbers: true,
        pagination: true, //分页组件
        pageSize: 50, //初始化显示条数
        pageList: [10, 50, 100, 200],
        loadMsg: '玩命加载数据中......',
        // striped:true, //斑马线效果
        singleSelect: true, //单选
        method: 'post',
        // pagePosition:'both'
        // SelectOnCheck:false
        /*loadFilter: function(data){
            console.info(data);
            return data;

        }*/

        // 子网络
        view: detailview,
        detailFormatter: function(index, row) {
            return '<div style="padding:2px"><table class="ddv" title="该客户消费明细列表"></table></div>';
        },
        onExpandRow: function(index, row) {
            var ddv = $(this).datagrid('getRowDetail', index).find('table.ddv');

            $.ajax({
                    url: '{:url("Consumption/getcpdetail")}?uid=' + row.id,
                    type: 'GET',
                    dataType: 'json',
                })
                .done(function(data) {
                    console.log(data);
                })
                .fail(function() {
                    console.log("error");
                });



            ddv.datagrid({
                url: '{:url("Consumption/getcpdetail")}?uid=' + row.id,
                fitColumns: true,
                singleSelect: true,
                rownumbers: true,
                loadMsg: '正在玩命加载详细列表......',
                height: 'auto',
                columns: [
                    [{
                        field: 'money',
                        title: '本次消费金额(元)',
                        width: 100
                    }, {
                        field: 'wd',
                        title: '网电咨询师',
                        width: 100
                    }, {
                        field: 'qt',
                        title: '前台咨询师',
                        width: 100
                    }, {
                        field: 'doctor',
                        title: '接诊医生',
                        width: 100
                    }, {
                        field: 'disease_name',
                        title: '就诊病种',
                        width: 100
                    }, {
                        field: 'ill_desc',
                        title: '病情描述',
                        width: 100
                    }, {
                        field: 'jz_time',
                        title: '就诊时间',
                        width: 100
                    }]
                ],
                onResize: function() {
                    $('#dg').datagrid('fixDetailRowHeight', index);
                },
                onLoadSuccess: function(data) {
                    console.log(data);
                    setTimeout(function() {
                        $('#dg').datagrid('fixDetailRowHeight', index);
                    }, 0);
                }
            });
            $('#dg').datagrid('fixDetailRowHeight', index);
        }
    });

    $('#reload').on('click', function() {
        $('#dg').datagrid('reload');
    })
});

function statusformater(value, row, index) {
    return row.summoney > 0 ? "<span class='status icon-ok'>dd</span>" : "<span class='status icon-cancel'>d</span>";
}

// 表单部分js
/*$('#myModal').modal({
    backdrop: false,
})*/
$('.datetimepicker').datepicker({
    language: 'zh-CN', //语言
    format: 'yyyy-mm-dd',
    autoclose: true,
    todayHighlight: true,
    todayBtn: "linked"
});
var link = function(nextdom, url, postdata, value, text) {
    $.ajax({
            url: url,
            type: 'POST',
            dataType: 'json',
            data: postdata
        })
        .done(function(data) {
            if (data) {
                // console.log(data);
                var html_temp = '';
                $.each(data, function(index, val) {
                    html_temp += "<option value='" + val[value] + "'>" + val[text] + "</option>";
                });
                // console.info(html_temp);
                nextdom.html("<option value=''>请选择</option>" + html_temp);
            }
        })
        .fail(function() {
            console.log("error");
        });
};


var initdata = function() {
    var nextdom = $('#userAttrCity'),
        url = "{:url('useradd/citylink')}"
    pid = $("#userAttrArea").val(),
        postdata = {
            'province_id': pid
        },
        value = 'city_id',
        text = 'city_name';
    link(nextdom, url, postdata, value, text);
}
initdata();

$('#userAttrArea').change(function() {
    $('#userAttrCounty').html('');
    initdata();
});
$('#userAttrCity').change(function() {
    var nextdom = $('#userAttrCounty'),
        url = "{:url('useradd/countylink')}"
    pid = $(this).val(),
        postdata = {
            'city_id': pid
        },
        value = 'county_id',
        text = 'county_name';
    link(nextdom, url, postdata, value, text);
});

$('#dev').change(function() {
    var nextdom = $('#from'),
        url = "{:url('link')}"
    pid = $(this).val(),
        postdata = {
            'id': pid
        },
        value = 'id',
        text = 'from',
        link(nextdom, url, postdata, value, text);
});

$('#submit').on('click', function() {
    $.ajax({
            url: '{:url("useradd")}',
            type: 'POST',
            dataType: 'html',
            data: $('#formdata').serialize()
        })
        .done(function(data) {
            // console.log(data);
            $('#msg').html('提示信息：' + data);
        })
        .fail(function() {
            console.log("error");
        });

    return false;

})
</script>



    
</body>
</html>
