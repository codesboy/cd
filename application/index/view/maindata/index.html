<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>客户数据</title>
<link href="__PUBLIC__static/easyui/css/easyui.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__static/easyui/css/icon.css" rel="stylesheet" type="text/css" />
<script src="__PUBLIC__static/easyui/js/jquery.min.js" type="text/javascript"></script>
<script src="__PUBLIC__static/easyui/js/jquery.easyui.min.js" type="text/javascript"></script>
<script src="__PUBLIC__static/easyui/js/easyui-lang-zh_CN.js" type="text/javascript"></script>
<script type="text/javascript" src="http://www.w3cschool.cc/try/jeasyui/datagrid-detailview.js"></script>
<style>
    body{margin: 0;padding: 0;}
    .yes{color: green;}
    .no{color: red;}
    .money{font-weight: bold;color: #f00;}
    /* .datagrid-header{position: fixed;} */
</style>
</head>
<body>
    <!-- <div style="margin:20px 0;"></div> -->
    
    <table id="dg" class="" title="客户消费情况表">
    </table>
    <div id="toolbar">
        <div style="margin-bottom:5px">
            <a href="" class="easyui-linkbutton" iconCls="icon-add" plain="true" title="添加客户">添加客户</a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true" title="编辑客户">编辑客户</a>
            <a href="{:url('')}" class="easyui-linkbutton" iconCls="icon-reload" plain="true" target="_blank" title="刷新数据">刷新数据</a>
            <a href="{:url('')}" class="easyui-linkbutton" iconCls="icon-more" plain="true" target="_blank" title="全屏显示表格">全屏显示表格</a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-save" plain="true"></a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-cut" plain="true"></a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true"></a>
        </div>
    </div>
    <script>


        $(function(){
            var money=0;
            $('#dg').datagrid({
                iconCls:'icon-save',
                autoRowHeight:false,
                // nowrap: false,
                url:'{:url('returndata')}',
                columns:[[
                    // {field:'id',title:'ID',width:1,width:'auto'},
                    {field:'checkbox',checkbox:true},
                    {field:'name',title:'姓名',width:80,halign:'center',align:'center'},
                    // {field:'usersn',title:'客户编号',width:100},
                    {field:'status',title:'是否成交',formatter:function(value,row,index){if(row.summoney>0){return '<span class="yes">已成交</span>'}else{return '<span class="no">未成交</span>'}},width:60},
                    {field:'sex',title:'性别',formatter: function (value) {if(value==1){return '男'}else if (value==2) {return '女'}else{return '未知'}},width:35},
                    {field:'birthday',title:'出生日期',width:100},
                    {field:'age',title:'年龄',sortable:true,width:40},
                    {field:'telephone',title:'手机号码',width:100},
                    {field:'province_name',title:'所在省份',width:100},
                    {field:'city_name',title:'所在市区',width:100},
                    {field:'county_name',title:'所在区县',width:100},
                    {field:'dev',title:'开发渠道',width:100},
                    {field:'from',title:'信息来源',width:100},
                    {field:'tool',title:'咨询工具',width:100},
                    {field:'wdname',title:'最近一次网电咨询师',width:100},
                    {field:'qtname',title:'最近一次前台咨询师',width:100},
                    {field:'doctor',title:'最近一次接诊医生',width:100},
                    {field:'disease_name',title:'最近一次就诊病种',width:100},
                    {field:'summoney',title:'消费总金额(元)',sortable:true,formatter:function(value){return '<span class="money">'+value+'</span>';},width:100},
                    {field:'addtime',title:'登记时间',width:100}
                ]],
                toolbar:"#toolbar",
                fitColumns:true, //表格宽度自适应
                rownumbers:true,
                pagination:true,//分页组件
                pageSize:50, //初始化显示条数
                pageList:[10,50,100,200],
                loadMsg:'玩命加载数据中......',
                // striped:true, //斑马线效果
                singleSelect:true, //单选
                method:'post',
                // pagePosition:'both'
                // SelectOnCheck:false
                /*loadFilter: function(data){
                    console.info(data);
                    return data;

                }*/

                // 子网络
                view: detailview,
                detailFormatter:function(index,row){
                    return '<div style="padding:2px"><table class="ddv" title="该客户消费详情列表"></table></div>';
                },
                onExpandRow: function(index,row){
                    var ddv = $(this).datagrid('getRowDetail',index).find('table.ddv');

                    $.ajax({
                        url: '{:url("Consumption/getcpdetail")}?uid='+row.id,
                        type: 'GET',
                        dataType: 'json',
                    })
                    .done(function(data) {
                        console.log(data);
                    })
                    .fail(function() {
                        console.log("error");
                    });



                    ddv.datagrid({
                        url:'{:url("Consumption/getcpdetail")}?uid='+row.id,
                        fitColumns:true,
                        singleSelect:true,
                        rownumbers:true,
                        loadMsg:'正在玩命加载详细列表......',
                        height:'auto',
                        columns:[[
                            {field:'money',title:'本次消费金额(元)',width:100},
                            {field:'wd',title:'网电咨询师',width:100},
                            {field:'qt',title:'前台咨询师',width:100},
                            {field:'doctor',title:'接诊医生',width:100},
                            {field:'disease_name',title:'就诊病种',width:100},
                            {field:'ill_desc',title:'病情描述',width:100},
                            {field:'jz_time',title:'就诊时间',width:100}
                        ]],
                        onResize:function(){
                            $('#dg').datagrid('fixDetailRowHeight',index);
                        },
                        onLoadSuccess:function(data){
                            console.log(data);
                            setTimeout(function(){
                                $('#dg').datagrid('fixDetailRowHeight',index);
                            },0);
                        }
                    });
                    $('#dg').datagrid('fixDetailRowHeight',index);
                }

            });
        });


        /*function getData(){
            var rows = [];
            for(var i=1; i<=19; i++){
                var amount = Math.floor(Math.random()*1000);
                var price = Math.floor(Math.random()*1000);
                rows.push({
                    inv: 'Inv No '+i,
                    date: $.fn.datebox.defaults.formatter(new Date()),
                    name: 'Name '+i,
                    amount: amount,
                    price: price,
                    cost: amount*price,
                    note: 'Note '+i
                });
            }
            return rows;
        }

        function pagerFilter(data){
            if (typeof data.length == 'number' && typeof data.splice == 'function'){    // is array
                data = {
                    total: data.length,
                    rows: data
                }
            }
            var dg = $(this);
            var opts = dg.datagrid('options');
            var pager = dg.datagrid('getPager');
            pager.pagination({
                onSelectPage:function(pageNum, pageSize){
                    opts.pageNumber = pageNum;
                    opts.pageSize = pageSize;
                    pager.pagination('refresh',{
                        pageNumber:pageNum,
                        pageSize:pageSize
                    });
                    dg.datagrid('loadData',data);
                }
            });
            if (!data.originalRows){
                data.originalRows = (data.rows);
            }
            var start = (opts.pageNumber-1)*parseInt(opts.pageSize);
            var end = start + parseInt(opts.pageSize);
            data.rows = (data.originalRows.slice(start, end));
            return data;
        }*/
    </script>
</body>
</html>
