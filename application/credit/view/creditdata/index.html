<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>客户积分数据</title>
<link rel="stylesheet" href="__PUBLIC__static/bootstrap/css/bootstrap.full.css">
<link rel="stylesheet" href="__PUBLIC__static/bootstrap/css/bootstrap-datepicker.min.css">
<link href="__PUBLIC__static/easyui/css/easyui.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__static/easyui/css/icon.css" rel="stylesheet" type="text/css" />
<script src="__PUBLIC__static/easyui/js/jquery.min.js" type="text/javascript"></script>
<script src="__PUBLIC__static/easyui/js/jquery.easyui.min.js" type="text/javascript"></script>
<script src="__PUBLIC__static/easyui/js/easyui-lang-zh_CN.js" type="text/javascript"></script>
<script src="__PUBLIC__static/easyui/js/datagrid-detailview.js"></script>


<script src="__PUBLIC__static/bootstrap/js/bootstrap.min.js"></script>
<script src="__PUBLIC__static/bootstrap/js/bootstrap-datepicker.min.js"></script>
<script src="__PUBLIC__static/bootstrap/js/bootstrap-datepicker.zh-CN.min.js"></script>
<style>
    body{margin: 0;padding: 0;}
    /* .yes{color: green;}
    .no{color: red;}
    .status{width: 16px;height: 15px;display: inline-block;font-size: 0px;} */
    .glyphicon-ok{color: #5cb85c;}
    .glyphicon-remove{color: #f0ad4e;}
    .money{font-weight: bold;color: #f00;}
    td{text-align: center;}
    /* .datagrid-header{position: fixed;} */
    .form-group{padding-bottom: 15px;}
    .control-label{text-align: right;/* width: 20%; */margin-right: 2%;}
    .form-control{width: 60%!important;}
    .line{border-bottom: 1px dashed #ccc;text-align: center;color: #888;margin-bottom: 20px;}
    .btns{text-align: center;}
    #msg{color: #f00;}
    /* 冲突样式重置 */
    .panel-header{width: 100%!important;}
    .panel-body{width: 100%!important;}
    .glyphicon{margin-right: 5px;}
    /*bootstrap兼容问题和easyui的bug*/
    /* .panel-header, .panel-body {
        border-width: 0px;
    }
    .datagrid,.combo-p{
        border:solid 1px #D4D4D4;
    }
    .datagrid *{
        -webkit-box-sizing: content-box;
        -moz-box-sizing: content-box;
        box-sizing: content-box;
    } */
</style>

</head>
<body>
    <table id="dg" class="" title="客户消费情况表">
    </table>
    <div id="toolbar" style="display: none">
        <div style="margin-bottom:5px">
            <div style="margin-bottom: 8px;">
                <a href="javascript:;" class="easyui-menubutton" menu="#mm1"><span class="glyphicon glyphicon-plus-sign"></span>添加</a>
                <div id="mm1" style="width:150px;">
                    <div iconCls="icon-undo" data-toggle="modal" data-target="#myModal">新增客户</div>
                    <!-- <div iconCls="icon-undo" onclick="$('#myModal').dialog('open')">新增客户</div> -->
                    <!-- <div iconCls="icon-undo" onclick="addTab('新增客户','/index/useradd/');">新增客户</div> -->
                    <div class="menu-sep"></div>
                    <div iconCls="icon-redo" id="addCon">新增消费</div>
                </div>
                <a href="javascript:;" class="easyui-linkbutton" plain="true" title="编辑客户"><span class="glyphicon glyphicon-edit"></span>编辑客户</a>
                <a id="reload" class="easyui-linkbutton" plain="true" target="_blank" title="刷新数据"><span class="glyphicon glyphicon-refresh"></span>刷新数据</a>
                <a href="{:url('')}" class="easyui-linkbutton" plain="true" target="_blank" title="全屏显示表格"><span class="glyphicon glyphicon-fullscreen"></span>全屏显示</a>
                <a href="javascript:;" class="easyui-linkbutton" plain="true"><span class="glyphicon glyphicon-export"></span>导出数据</a>
            </div>
            <div class="btn-toolbar" role="toolbar" style="margin-bottom: 8px;">
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-default">今日</button>
                    <button type="button" class="btn btn-default">昨日</button>
                    <button type="button" class="btn btn-default">本周</button>
                    <button type="button" class="btn btn-default">本月</button>
                    <button type="button" class="btn btn-default">本季度</button>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 8px;">
            模糊查询（姓名/手机号）：<input id="mohu" class="easyui-textbox" type="text" style="width: 100px">
            Money From：<input id="startmoney" class="easyui-textbox" style="width:100px">
            To：<input id="endmoney" class="easyui-textbox" style="width:100px">
            <a href="javascript:;" id="search" class="easyui-linkbutton"><span class="glyphicon glyphicon-search"></span>Search</a>
        </div>
    </div>


<script>
    // datagrid部分js
    $(function() {
        // 主要数据
        $('#dg').datagrid({
            iconCls: 'icon-list',
            autoRowHeight: false,
            // nowrap: false,
            url: '{:url('returnCreditData')}',
            columns:[[
                // {field:'id',title:'ID',width:1,width:'auto'},
                {field:'checkbox',checkbox:true},
                {field:'name',title:'姓名',width:80,halign:'center',align:'center'},
                // {field:'usersn',title:'客户编号',width:100},
                // {field:'status',title:'成交',formatter:statusformater,align:'center',width:45},
                {field:'telephone',title:'手机号码',width:80},
                {field:'sex',title:'性别',formatter: function (value) {if(value==1){return '男'}else if (value==2) {return '女'}else{return '未知'}},width:45},
                // {field:'birthday',title:'出生日期',width:70},
                {field:'age',title:'年龄',sortable:true,width:40},
                {field:'province_name',title:'应付总消费金额',width:70},
                {field:'city_name',title:'总使用积分',width:100},
                {field:'city_name',title:'实际总消费金额',width:100},
                {field:'city_name',title:'剩余积分',width:100},
                {field:'city_name',title:'推荐者',width:120}
            ]],
            toolbar: "#toolbar",
            fitColumns: true, //表格宽度自适应
            rownumbers: true,
            pagination: true, //分页组件
            pageSize: 50, //初始化显示条数
            pageList: [10, 50, 100, 200],
            loadMsg: '玩命加载数据中......',
            // striped:true, //斑马线效果
            singleSelect: true, //单选
            method: 'post',

            // 子网络
            view: detailview,

            onExpandRow: function(index, row) {
                var ddv = $(this).datagrid('getRowDetail', index).find('table.ddv');

                ddv.datagrid({
                    url: '{:url("Consumption/getcpdetail")}?uid=' + row.id,
                    fitColumns: true,
                    singleSelect: true,
                    rownumbers: true,
                    loadMsg: '正在玩命加载详细列表......',
                    height: 'auto',
                    showFooter: true,
                    columns: [[
                        {field: 'footer',title: '',width: 100},
                        {field: 'money',title: '本次消费金额(元)',width: 100},
                        {field: 'wd',title: '网电咨询师',width: 100},
                        {field: 'qt',title: '前台咨询师',width: 100},
                        {field: 'doctor',title: '接诊医生',width: 100},
                        {field: 'disease_name',title: '就诊病种',width: 100},
                        {field: 'ill_desc',title: '病情描述',width: 100},
                        {field: 'jz_time',title: '就诊时间',width: 100}
                    ]],
                    onResize: function() {
                        $('#dg').datagrid('fixDetailRowHeight', index);
                    },
                    onLoadSuccess: function(data) {
                        // console.log(data);
                        setTimeout(function() {
                            $('#dg').datagrid('fixDetailRowHeight', index);
                        }, 0);
                    }
                });
                $('#dg').datagrid('fixDetailRowHeight', index);
            },
            detailFormatter: function(index, row) {
                return '<div style="padding:2px"><table class="ddv" title="该客户消费明细列表"></table></div>';
            }
        });
        // 刷新数据
        $('#reload').on('click', function() {
            $('#dg').datagrid('reload');
        });


    });

    function statusformater(value, row, index) {
        return row.summoney > 0 ? "<span class='glyphicon glyphicon-ok success'></span>" : "<span class='glyphicon glyphicon-remove'></span>";

    }

    // 表单部分js
    $('#myModal').modal({
        // backdrop: false,
        show:false
    })
    $('.datetimepicker').datepicker({
        language: 'zh-CN', //语言
        format: 'yyyy-mm-dd',
        autoclose: true,
        todayHighlight: true,
        todayBtn: "linked"
    });





    $('#dev').change(function() {
        var nextdom = $('#from'),
            url = "{:url('link')}"
        pid = $(this).val(),
            postdata = {
                'id': pid
            },
            value = 'id',
            text = 'source_name',
            link(nextdom, url, postdata, value, text);
    });
    // 添加用户
    $('#submit').on('click', function() {
        $.ajax({
                url: '{:url("useradd/useradd")}',
                type: 'POST',
                dataType: 'html',
                data: $('#formdata').serialize()
            })
            .done(function(data) {
                // console.log(data);
                $('#msg').html('提示信息：' + data);
                if (data == '"客户添加成功!"') {
                    $('#submit').attr('disabled', true);
                    $('#formdata').get(0).reset();
                    $('#msg').html('');
                    // $('#myModal').modal('hide');
                    $('#addUserDialog').modal();
                    $('#submit').attr('disabled', false);
                }
            })
            .fail(function() {
                console.log("error");
            });

        return false;

    });

    // 添加就诊/消费记录
    $('#addCon').on('click',function(event) {
        var selected=$('#dg').datagrid('getSelected');
        // console.info(selected)
        if(selected){
            $('#addcontitle').html('为客户 '+selected.name+'('+selected.telephone+') 添加就诊/消费记录');
            $('#addConModal').modal();
            $('#addconbtn').on('click', function(event) {

                var addcondata=$('#addconform').serialize();
                addcondata=addcondata+'&uid='+selected.id;

                $.ajax({
                    url: '{:url('Consumption/addcon')}',
                    type: 'POST',
                    dataType: 'html',
                    data: addcondata
                })
                .done(function(conaddresult) {

                    console.log(conaddresult)
                    if(conaddresult=='"该用户消费记录添加成功！"'){
                        $('#addconbtn').attr('disabled',true);
                        $('#addconform').get(0).reset();
                        $('#addConModal').modal('hide');
                        $('#addConDialog').modal();
                    }else{
                        $('.addconmsg').html('提示信息：'+conaddresult);
                    }

                })
                .fail(function() {
                    console.log("error");
                });
                return false;
            });
            $('#secAddCon').on('click',function(){
                $('#addConDialog').modal('hide');
                $('#addConModal').modal();
                $('#addconbtn').attr('disabled',false);
                $('.addconmsg').html('');
            })


        }else{
            alert('请选择用户');
        }

    });

    // 搜索功能
    $('#search').on('click',function(){
        $('#dg').datagrid('load',{
            name: $('#mohu').val(),
            startmoney: $('#startmoney').val(),
            endmoney: $('#endmoney').val(),
        });
    })
</script>




</body>
</html>
